<!DOCTYPE html>
<html>
  <head>
    <title>Trinsic OIDC Tester</title>
    <link rel="stylesheet" href="./App.css" />
  </head>
  <body>
    <div>
      <a href="./index.html">clear url</a>
      <a class="hidden" href="./sample-silent-signin.html">clear url</a>
      <a class="hidden" href="./sample-popup-signin.html">clear url</a>
    </div>
    <div>
      <button id="clearState">clear stale state</button>
      <button id="getUser">get user</button>
      <button id="removeUser">remove user</button>
    </div>
    <div>
      <button id="iframeSignin">signin with iframe</button>
      <button id="popUpSignIn">signin with popup</button>
    </div>

    <pre id="out"></pre>

    <script
      type="module"
      id="trinsic-oidc"
      src="https://unpkg.com/trinsic-oidc-client-ts@0.0.7/dist/browser/oidc-client-ts.js"
    ></script>
    <script>
      window.OIDCSettings = {
        authority: 'https://dev-connect.trinsic.cloud/',
        client_id: `${window.location.origin}`,
        silent_redirect_uri: `${window.location.origin}/sample-silent-signin.html`,
        popup_redirect_uri: `${window.location.origin}/sample-popup-signin.html`,
        silentRequestTimeoutInSeconds: 600,
        iframeHidden: false,
        response_type: 'code',
        scope: 'openid',
        prompt: undefined,
        extraQueryParams: {
          'trinsic:ecosystem': 'hersh-test',
          'trinsic:schema':
            'https://dev-schema.trinsic.cloud/hersh-test/zbettertemplate',
        },
      }

      document.querySelector('#trinsic-oidc').addEventListener('load', () => {
        const Log = window.oidc.Log
        const UserManager = window.oidc.UserManager

        Log.setLogger(console)
        Log.setLevel(Log.INFO)
        function log() {
          document.getElementById('out').innerText = ''

          Array.prototype.forEach.call(arguments, function (msg) {
            if (msg instanceof Error) {
              msg = 'Error: ' + msg.message
            } else if (typeof msg !== 'string') {
              msg = JSON.stringify(msg, null, 2)
            }
            document.getElementById('out').innerHTML += msg + '\r\n'
          })
        }

        ///////////////////////////////
        // config
        ///////////////////////////////
        const mgr = new UserManager(window.OIDCSettings)

        mgr.events.addUserLoaded(function (user) {
          console.log('user loaded', user)
          mgr.getUser().then(
            function () {
              console.log('getUser loaded user after userLoaded event fired')
            },
            () => {},
          )
        })

        mgr.events.addUserUnloaded(function (e) {
          console.log('user unloaded')
        })

        ///////////////////////////////
        // functions for UI elements
        ///////////////////////////////
        const clearState = () => {
          mgr
            .clearStaleState()
            .then(() => {
              log('clearStateState success')
            })
            .catch((err) => {
              console.error(err)
              log(err)
            })
        }

        const getUser = () => {
          mgr
            .getUser()
            .then((user) => {
              log('got user', user)
            })
            .catch((err) => {
              console.error(err)
              log(err)
            })
        }

        const removeUser = () => {
          mgr
            .removeUser()
            .then(() => {
              log('user removed')
            })
            .catch((err) => {
              console.error(err)
              log(err)
            })
        }

        const popupSignin = () => {
          removeUser()
          clearState()
          mgr
            .signinPopup()
            .then((user) => {
              log('signed in', user)
            })
            .catch((err) => {
              console.error(err)
              log(err)
            })
        }

        const iframeSignin = () => {
          removeUser()
          clearState()
          mgr
            .signinSilent()
            .then((user) => {
              log('signed in', user)
            })
            .catch((err) => {
              console.error(err)
              log(err)
            })
        }

        ///////////////////////////////
        // UI event handlers
        ///////////////////////////////
        document
          .getElementById('clearState')
          .addEventListener('click', clearState, false)
        document
          .getElementById('getUser')
          .addEventListener('click', getUser, false)
        document
          .getElementById('removeUser')
          .addEventListener('click', removeUser, false)

        document
          .getElementById('iframeSignin')
          .addEventListener('click', iframeSignin, false)

        document
          .getElementById('popUpSignIn')
          .addEventListener('click', popupSignin, false)

        ///////////////////////////////
        // We can also just automatically
        // start the iFrame login on page load
        ///////////////////////////////
        iframeSignin()
      })
    </script>
  </body>
</html>
